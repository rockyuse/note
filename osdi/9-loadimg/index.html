<!DOCTYPE html>
<html lang="zh_TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">

    
      <link rel="icon" href="/note/shell.png" />
    

    <title>
        
          Load Image by UART - kaiiiz/note
        
    </title>

    <!-- Spectre.css framework -->
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-exp.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-icons.min.css">

    <!-- theme css & js -->
    
<link rel="stylesheet" href="/note/css/book.css">

    
<script src="/note/js/book.js"></script>


    <!-- tocbot -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
    
    <!-- katex -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">

    
<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-112717568-5', 'auto');
ga('send', 'pageview');
</script>
<!-- End Google Analytics -->

    
<script src="https://cdnjs.cloudflare.com/ajax/libs/zooming/2.1.1/zooming.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const zooming = new Zooming()
    zooming.listen('.book-content img')
})
</script>

<meta name="generator" content="Hexo 4.2.0"></head>

<body>

<div class="book-container">
  <div class="book-sidebar">
    <div class="book-brand">
  <a href="/note/">
    <img src="/note/shell.png">
    <span>KAIIIZ/NOTE</span>
  </a>
</div>
    <div class="book-menu">
  <ul>
<li><a href="/note">Home</a></li>
</ul>
<h2 id="osdi">OSDI</h2>
<ul>
<li><a href="/note/osdi/0-intro">Introduction</a></li>
<li><a href="/note/osdi/0-memory-map">Memory Map</a></li>
<li><a href="/note/osdi/1-env">Environment</a></li>
<li>Lab1
<ul>
<li><a href="/note/osdi/2-basic-init">Basic Initialization</a></li>
<li><a href="/note/osdi/3-uart">UART</a></li>
<li><a href="/note/osdi/4-mini-uart">Mini UART</a></li>
<li><a href="/note/osdi/5-simple-shell">Simple Shell</a></li>
</ul>
</li>
<li>Lab2
<ul>
<li><a href="/note/osdi/6-mailbox">Mailbox</a></li>
<li><a href="/note/osdi/7-pl011-uart">PL011 UART</a></li>
<li><a href="/note/osdi/8-frame-buffer">Frame Buffer</a></li>
<li><a href="/note/osdi/9-loadimg">3rd Bootloader</a></li>
</ul>
</li>
</ul>
<h2 id="parallel-programming">Parallel Programming</h2>
<ul>
<li><a href="/note/pp/shared-memory">Shared Memory</a></li>
<li>Pthread
<ul>
<li><a href="/note/pp/pthread/basic">Basic</a></li>
<li><a href="/note/pp/pthread/sync">Synchronization</a></li>
<li><a href="/note/pp/pthread/advanced">Advanced</a></li>
<li><a href="/note/pp/pthread/thread-pool">Thread Pool</a></li>
</ul>
</li>
<li>OpenMP
<ul>
<li><a href="/note/pp/openmp/basic">Basic</a></li>
<li><a href="/note/pp/openmp/worksharing-constructs">Worksharing Constructs</a></li>
<li><a href="/note/pp/openmp/synchronization">Synchronization</a></li>
<li><a href="/note/pp/openmp/variable-scope">Variable Scope</a></li>
</ul>
</li>
<li>MPI
<ul>
<li><a href="/note/pp/mpi/basic">Basic</a></li>
<li><a href="/note/pp/mpi/p2p-comm">Point-to-Point Comm.</a></li>
<li><a href="/note/pp/mpi/collective-comm">Collective Comm.</a></li>
<li><a href="/note/pp/mpi/consolidating-data">Consolidating Data</a></li>
<li><a href="/note/pp/mpi/additional-topics">Additional Topics</a></li>
</ul>
</li>
<li><a href="/note/pp/cuda">CUDA</a></li>
<li><a href="/note/pp/opencl">OpenCL</a></li>
</ul>
<h2 id="machine-learning">Machine Learning</h2>
<ul>
<li>Supervised Learning
<ul>
<li><a href="/note/ml/supervised/naive-bayes">Naive Bayes</a></li>
<li><a href="/note/ml/supervised/decision-tree">Decision Tree</a></li>
<li><a href="/note/ml/supervised/random-forest">Random Forest</a></li>
<li><a href="/note/ml/supervised/linear-regression">Linear Regression</a></li>
<li><a href="/note/ml/supervised/logistic-regression">Logistic Regression</a></li>
</ul>
</li>
<li>Deep Learning
<ul>
<li><a href="/note/ml/deep/backpropagation">Backpropagation</a></li>
</ul>
</li>
</ul>
<h2 id="network-services-adm">Network Services Adm.</h2>
<ul>
<li>Containers
<ul>
<li><a href="/note/na/lxc">LXC</a></li>
</ul>
</li>
<li>DNS Server
<ul>
<li><a href="/note/na/dns-server/intro">Introduction</a></li>
<li><a href="/note/na/dns-server/bind">BIND</a></li>
<li><a href="/note/na/dns-server/delegation+slave">Delegation &amp; Slave</a></li>
<li><a href="/note/na/dns-server/logging">Logging</a></li>
<li><a href="/note/na/dns-server/view">View</a></li>
<li><a href="/note/na/dns-server/security">Security</a></li>
</ul>
</li>
<li><a href="/note/na/dhcp-server">DHCP Server</a></li>
<li><a href="/note/na/firewall+nat-server">Firewall &amp; NAT Server</a></li>
<li><a href="/note/na/ftp-server+openldap">FTP with LDAP-Backend</a></li>
<li><a href="/note/na/http-proxy">HTTP Proxy</a></li>
<li>Mail Server
<ul>
<li><a href="/note/na/mail-server/mta+mra">MTA、MRA</a></li>
<li><a href="/note/na/mail-server/security">Security</a></li>
<li><a href="/note/na/mail-server/anti-scam">Anti-Scam</a></li>
<li><a href="/note/na/mail-server/anti-spam">Anti-Spam</a></li>
<li><a href="/note/na/mail-server/webmail+alias">Webmail、Alias</a></li>
</ul>
</li>
</ul>

</div>


<script src="/note/js/book-menu.js"></script>

  </div>

  <div class="sidebar-toggle" onclick="sidebar_toggle()" onmouseover="add_inner()" onmouseleave="remove_inner()">
  <div class="sidebar-toggle-inner"></div>
</div>

<script>
function add_inner() {
  let inner = document.querySelector('.sidebar-toggle-inner')
  inner.classList.add('show')  
}

function remove_inner() {
  let inner = document.querySelector('.sidebar-toggle-inner')
  inner.classList.remove('show')
}

function sidebar_toggle() {
    let sidebar_toggle = document.querySelector('.sidebar-toggle')
    let sidebar = document.querySelector('.book-sidebar')
    let content = document.querySelector('.off-canvas-content')
    if (sidebar_toggle.classList.contains('extend')) { // show
        sidebar_toggle.classList.remove('extend')
        sidebar.classList.remove('hide')
        content.classList.remove('extend')
    }
    else { // hide
        sidebar_toggle.classList.add('extend')
        sidebar.classList.add('hide')
        content.classList.add('extend')
    }
}
</script>

  <div class="off-canvas-content">
    <div class="columns">
      <div class="column col-10 col-lg-12">
        <div class="book-navbar">
          <!-- For Responsive Layout -->

<header class="navbar">
  <section class="navbar-section">
    <a onclick="open_sidebar()">
      <i class="icon icon-menu"></i>
    </a>
  </section>
</header>

        </div>
        <div class="book-content">
          <div class="book-post">
  <h1 id="load-image-by-uart">Load Image by UART</h1>
<blockquote>
<p><a href="https://github.com/kaiiiz/osdi2020/tree/5d40a549b439d11bfd87bc398aa3aa9d81e5fb6e" target="_blank" rel="noopener">https://github.com/kaiiiz/osdi2020/tree/5d40a549b439d11bfd87bc398aa3aa9d81e5fb6e</a></p>
</blockquote>
<p>Create 3rd bootloader</p>
<h2 id="relocate">Relocate</h2>
<p>一開場就把自己搬家到 <code>0x3B3FC000</code>，以免執行 load image 時被蓋掉</p>
<p>linker.ld</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line">SECTIONS</span><br><span class="line">&#123;</span><br><span class="line">  . &#x3D; 0x80000;</span><br><span class="line">  .relocate :</span><br><span class="line">  &#123;</span><br><span class="line">    KEEP(*(.text.relocate))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  . &#x3D; ALIGN(4096);</span><br><span class="line">  _begin &#x3D; .;</span><br><span class="line">  .text :</span><br><span class="line">  &#123;</span><br><span class="line">    KEEP(*(.text.boot))</span><br><span class="line">    *(.text)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  . &#x3D; ALIGN(4096);</span><br><span class="line">  .data :</span><br><span class="line">  &#123;</span><br><span class="line">    *(.data)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  . &#x3D; ALIGN(4096);</span><br><span class="line">  .bss (NOLOAD) :</span><br><span class="line">  &#123;</span><br><span class="line">    __bss_start &#x3D; .;</span><br><span class="line"></span><br><span class="line">    *(.bss)</span><br><span class="line"></span><br><span class="line">    __bss_end &#x3D; .;</span><br><span class="line">  &#125;</span><br><span class="line">  _end &#x3D; .;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__bss_size &#x3D; (__bss_end - __bss_start) &gt;&gt; 3;</span><br><span class="line">__boot_loader &#x3D; 0x3B3FC000;</span><br></pre></td></tr></table></figure>
<p>start.s</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">.section &quot;.text.relocate&quot;</span><br><span class="line"></span><br><span class="line">.global _relocate</span><br><span class="line"></span><br><span class="line">_relocate:</span><br><span class="line">    &#x2F;&#x2F; get cpu id</span><br><span class="line">    mrs     x1, MPIDR_EL1</span><br><span class="line">    and     x1, x1, #3</span><br><span class="line">    cbz     x1, 2f</span><br><span class="line">    &#x2F;&#x2F; if cpu_id &gt; 0, stop</span><br><span class="line">1:</span><br><span class="line">    wfe</span><br><span class="line">    b       1b</span><br><span class="line">    &#x2F;&#x2F; if cpu_id &#x3D;&#x3D; 0</span><br><span class="line">2:</span><br><span class="line">    &#x2F;&#x2F; set stack pointer</span><br><span class="line">    ldr     x1, &#x3D;__boot_loader</span><br><span class="line">    mov     sp, x1</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; clear bss</span><br><span class="line">    ldr     x1, &#x3D;__bss_start</span><br><span class="line">    ldr     x2, &#x3D;__bss_size</span><br><span class="line">3:  cbz     x2, 4f</span><br><span class="line">    str     xzr, [x1], #8</span><br><span class="line">    sub     x2, x2, #1</span><br><span class="line">    cbnz    x2, 3b</span><br><span class="line"></span><br><span class="line">4:  bl      relocate</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.section &quot;.text.boot&quot;</span><br><span class="line"></span><br><span class="line">.global _start</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">    &#x2F;&#x2F; jump to main function in C</span><br><span class="line">    bl      main</span><br><span class="line">    &#x2F;&#x2F; halt this core if return</span><br><span class="line">1:</span><br><span class="line">    wfe</span><br><span class="line">    b       1b</span><br></pre></td></tr></table></figure>
<p>relocate.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> _begin, _end, __boot_loader;</span><br><span class="line"></span><br><span class="line">__attribute__((section(<span class="string">".text.relocate"</span>))) <span class="function"><span class="keyword">void</span> <span class="title">relocate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_size = (&amp;_end - &amp;_begin);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *new_bl = (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)&amp;__boot_loader;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *bl = (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)&amp;_begin;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (kernel_size--) &#123;</span><br><span class="line">        *new_bl++ = *bl;</span><br><span class="line">        *bl++ = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> (*start)(<span class="keyword">void</span>) = (<span class="keyword">void</span> *)&amp;__boot_loader;</span><br><span class="line">    start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="load-image">Load Image</h2>
<p>loadimg.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">loadimg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> address = address_input();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (address == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    uart_printf(<span class="string">"Send image via UART now!\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// big endian</span></span><br><span class="line">    <span class="keyword">int</span> img_size = <span class="number">0</span>, i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">        img_size &lt;&lt;= <span class="number">8</span>;</span><br><span class="line">        img_size |= (<span class="keyword">int</span>)uart_read_raw();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// big endian</span></span><br><span class="line">    <span class="keyword">int</span> img_checksum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">        img_checksum &lt;&lt;= <span class="number">8</span>;</span><br><span class="line">        img_checksum |= (<span class="keyword">int</span>)uart_read_raw();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *kernel = (<span class="keyword">char</span> *)address;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; img_size; i++) &#123;</span><br><span class="line">        <span class="keyword">char</span> b = uart_read_raw();</span><br><span class="line">        *(kernel + i) = b;</span><br><span class="line">        img_checksum -= (<span class="keyword">int</span>)b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (img_checksum != <span class="number">0</span>) &#123;</span><br><span class="line">        uart_printf(<span class="string">"Failed!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">void</span> (*start_os)(<span class="keyword">void</span>) = (<span class="keyword">void</span> *)kernel;</span><br><span class="line">        start_os();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><span>sendimg.py</span></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">checksum</span><span class="params">(bytecodes)</span>:</span></span><br><span class="line">    <span class="comment"># convert bytes to int</span></span><br><span class="line">    <span class="keyword">return</span> int(np.array(list(bytecodes), dtype=np.int32).sum())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        ser = serial.Serial(args.tty, <span class="number">115200</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        print(<span class="string">"Serial init failed!"</span>)</span><br><span class="line">        exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    file_path = args.image</span><br><span class="line">    file_size = os.stat(file_path).st_size</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> open(file_path, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        bytecodes = f.read()</span><br><span class="line"></span><br><span class="line">    file_checksum = checksum(bytecodes)</span><br><span class="line"></span><br><span class="line">    ser.write(file_size.to_bytes(<span class="number">4</span>, byteorder=<span class="string">"big"</span>))</span><br><span class="line">    ser.write(file_checksum.to_bytes(<span class="number">4</span>, byteorder=<span class="string">"big"</span>))</span><br><span class="line"></span><br><span class="line">    print(<span class="string">f"Image Size: <span class="subst">&#123;file_size&#125;</span>, Checksum: <span class="subst">&#123;file_checksum&#125;</span>"</span>)</span><br><span class="line"></span><br><span class="line">    per_chunk = <span class="number">128</span></span><br><span class="line">    chunk_count = file_size // per_chunk</span><br><span class="line">    chunk_count = chunk_count + <span class="number">1</span> <span class="keyword">if</span> file_size % per_chunk <span class="keyword">else</span> chunk_count</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(chunk_count):</span><br><span class="line">        sys.stdout.write(<span class="string">'\r'</span>)</span><br><span class="line">        sys.stdout.write(<span class="string">"%d/%d"</span> % (i + <span class="number">1</span>, chunk_count))</span><br><span class="line">        sys.stdout.flush()</span><br><span class="line">        ser.write(bytecodes[i * per_chunk: (i+<span class="number">1</span>) * per_chunk])</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> ser.writable():</span><br><span class="line">            <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<h2 id="notes">Notes</h2>
<h3 id="x86-boot-flow">x86 Boot Flow</h3>
<ol>
<li>Waiting power supply to settle to nominal state</li>
<li>Fetch BIOS from ROM</li>
</ol>
<p>BIOS:</p>
<ol>
<li>Power-On Self-Test</li>
<li>Load boot configuration (e.g. boot order)</li>
<li>Load the Stage 1 bootloader</li>
</ol>
<p>Stage 1 Bootloader:</p>
<ol>
<li>Read MBR on disk</li>
<li>Setup a stack</li>
<li>Load the Stage 2 bootloader</li>
</ol>
<p>Stage 2 bootloader:</p>
<ol>
<li>Read configuration file to startup a boot selection menu (e.g. GRUB)</li>
<li>Load kernel</li>
</ol>
<blockquote>
<p>Ref: <a href="https://www.diag.uniroma1.it/~pellegrini/didattica/2017/aosv/1.Initial-Boot-Sequence.pdf" target="_blank" rel="noopener">x86 Initial Boot Sequence</a></p>
</blockquote>
<h3 id="grub">GRUB</h3>
<p>BIOS:</p>
<ul>
<li>依設定順序找尋軟碟機、光碟槽、隨身碟或硬碟中是否有 boot sector</li>
<li>執行 BIOS interrupt, INT 13H，這個 interrupt 定位所有可開機裝置的 boot sectors，接著把 boot sector 載入 RAM</li>
<li>把控制權交給已經載入 RAM 的 boot sector，boot sector 也就是 1st stage boot loader (MBR 階段)</li>
</ul>
<p>GRUB2 Stage 1 boot loader:</p>
<ul>
<li><strong>boot.img</strong></li>
<li>必需要符合 MBR 的大小，MBR 為 512 byte，位於磁碟中的第一個 sector，內容包含 boot loader 程式碼及 partition table
<ul>
<li>前 446 bytes 為 stage 1 boot loader，包含可執行程式碼及錯誤訊文字</li>
<li>後 64 bytes 是磁區分割表(partition table)，分別儲存著四個磁區中，每個磁區的資料，也就是每個磁區的資料為 16 bytes</li>
<li>最後兩個 bytes 是 magic number (0xAA55)，用於驗証 MBR 的合法性</li>
</ul>
</li>
<li>因為 stage 1 boot loader 很小，所以它不聰明，認不得檔案系統，因此 stage 1 boot loader 的主要任務是載入 stage 1.5 boot loader</li>
<li>GRUB2 stage 1.5 通常位於磁碟的 boot record 和第一個磁區之間的位置，再把 GRUB2 stage 1.5 載入 memory 後，會把控制權交給 GRUB2 stage 1.5</li>
</ul>
<p>GRUB2 Stage 1.5 boot loader:</p>
<ul>
<li><strong>core.img</strong></li>
<li>包含一些常見檔案系統的 driver，像是 EXT, FAT, NTFS，這表示 GRUB2 stage 2 可以位於標準的 EXT 檔案系統內</li>
<li>明確地說，GRUB2 stage 2 的檔案位於 /boot/grub2</li>
</ul>
<blockquote>
<p>通常來說，磁碟上的第一個磁區會位於第 63 個 sector，MBR 為第 0 個 sector，也就是說，留下了 62 個 512 bytes 的空間供 GRUB2 stage 1.5 使用</p>
</blockquote>
<blockquote>
<p>注意 /boot 資料夾一定要位在 GRUB2 stage 1.5 可以認得的檔案系統內，GRUB2 stage 1.5 的主要任務就是載入可以取得 GRUB2 stage 2 檔案的檔案系統 driver，及其它需要的 driver</p>
</blockquote>
<p>GRUB2 Stage 2 boot loader:</p>
<ul>
<li>大多是 runtime kernel modules，位於 /boot/grub2/i386-pc/ 資料夾內，被有需求時，再載入 kernel</li>
<li>最主要的任務就是載入 Linux kernel 到 RAM 中，然後把控制權交給 kernel</li>
<li>kernel 和相關的檔案都位於 /boot/ 資料夾內，kernel 的名稱以 vmlinuz 為開頭，例如：/boot/vmlinuz-4.15.0-74-generic。</li>
</ul>
<p>Kernel:</p>
<ul>
<li>GRUB 把 kernel 載入 RAM中</li>
<li>initramfs 也會同時被載入到 RAM 中，它含有在 kernel 啟動時所必要的驅動程式</li>
<li>在 kernel 被載入到 RAM 並開始執行後，它的第一步是先自我解壓縮，等解壓縮完成之後，接著載入 Init(systemd)，然後把控制權交給 systemd</li>
</ul>
<blockquote>
<p>Ref: <a href="https://silverwind1982.pixnet.net/blog/post/358594004-linux-%E7%9A%84%E9%96%8B%E6%A9%9F%E6%B5%81%E7%A8%8B-%28bios%29" target="_blank" rel="noopener">桌機 Linux 的開機流程 (BIOS +GRUB2)</a></p>
</blockquote>
<h3 id="loading-speed">Loading speed</h3>
<blockquote>
<p>Calculate how long will it take for loading a 10MB kernel image by UART if baud rate is 115200.</p>
</blockquote>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">(</mo><mfrac><mn>1</mn><mn>115200</mn></mfrac><mo>×</mo><mn>10</mn><mo stretchy="false">)</mo><mo>×</mo><mn>10</mn><mo>×</mo><mn>1024</mn><mo>×</mo><mn>1024</mn><mo>=</mo><mn>910.22</mn><mtext>(s)</mtext></mrow><annotation encoding="application/x-tex">(\frac{1}{115200} \times 10) \times 10 \times 1024 \times 1024 = 910.22 \text{(s)}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">1</span><span class="mord">5</span><span class="mord">2</span><span class="mord">0</span><span class="mord">0</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mord">2</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mord">2</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">9</span><span class="mord">1</span><span class="mord">0</span><span class="mord">.</span><span class="mord">2</span><span class="mord">2</span><span class="mord text"><span class="mord">(s)</span></span></span></span></span></span></p>

</div>


  <div class="book-comments">
    


    <div id="disqus_thread"></div>
    <script>
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://at881005.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>



  </div>



<script src="/note/js/book-post.js"></script>

        </div>
      </div>
      <div class="column col-2 hide-lg">
        <div class="book-post-info">
  
    <div class="book-post-meta">

  <div class="author">

    <!-- Author image -->
    <div class="author-img">
      
        <figure class="avatar avatar-lg">
          <img src="/note/andy.png" alt="...">
        </figure>
      
    </div>

    <!-- Author title -->
    <div class="author-title">
      <div>Andy Zheng</div>
      <div>2020-04-03</div>
    </div>
  </div>

  
    <div class="divider"></div>

    <div class="link">
      

      <a class="tag-link" href="/note/tags/OSDI/" rel="tag">#OSDI</a>
    </div>
    
  

  <div class="divider"></div>
</div>
  

  <div class="book-tocbot">
</div>
<div class="book-tocbot-menu">
  <a class="book-toc-expand" onclick="expand_toc()">Expand all</a>
  <a onclick="go_top()">Back to top</a>
  <a onclick="go_bottom()">Go to bottom</a>
</div>


<script src="/note/js/book-toc.js"></script>

</div>
      </div>
    </div>
  </div>
  
  <a class="off-canvas-overlay" onclick="hide_canvas()"></a>
</div>

</body>
</html>


<script src="/note/js/book.js"></script>
